$(function() {

    "use strict";

    $(function() {

        $(".preloader").fadeOut()

    }), jQuery(document).on("click", ".mega-dropdown", function(e) {

        e.stopPropagation()

    });

    var e = function() {

        (window.innerWidth > 0 ? window.innerWidth : this.screen.width) < 1170 ? ($("body").addClass("mini-sidebar"), $(".sidebartoggler i").addClass("ti-menu")) : $("body").removeClass("mini-sidebar");

        var e = (window.innerHeight > 0 ? window.innerHeight : this.screen.height) - 1;

        (e -= 190) < 1 && (e = 1), e > 190 && $(".page-wrapper").css("min-height", e + "px")

    };



    function a() {

        $(window).scrollTop() > 80 ? ($("body").addClass("fixed-sidebar"), $(".left-sidebar").addClass("animated slideInDown")) : ($("body").removeClass("fixed-sidebar"), $(".left-sidebar").removeClass("animated slideInDown"))

    }

    $(window).ready(e), $(window).on("resize", e), $(".sidebartoggler").on("click", function() {

        $("body").hasClass("mini-sidebar") ? ($("body").trigger("resize"), $("body").removeClass("mini-sidebar"), $(".navbar-brand span").show()) : ($("body").trigger("resize"), $("body").addClass("mini-sidebar"), $(".navbar-brand span").hide())

    }), $(".nav-toggler").click(function() {

        $("body").toggleClass("show-sidebar"), $(".nav-toggler i").toggleClass("ti-menu"), $(".nav-toggler i").addClass("ti-close")

    }), $(".search-box a, .search-box .app-search .srh-btn").on("click", function() {

        $(".app-search").toggle(200)

    }), $(".right-side-toggle").click(function() {

        $(".right-sidebar").slideDown(50), $(".right-sidebar").toggleClass("shw-rside")

    }), $(".floating-labels .form-control").on("focus blur", function(e) {

        $(this).parents(".form-group").toggleClass("focused", "focus" === e.type || this.value.length > 0)

    }).trigger("blur"), $(function() {

        //$('[data-toggle="tooltip"]').tooltip()

    }), $(function() {

        //$('[data-toggle="popover"]').popover()

    }), $(".right-side-panel, .message-center, .right-sidebar").perfectScrollbar(), $("body").trigger("resize"), $(".list-task li label").click(function() {

        $(this).toggleClass("task-done")

    }), $('a[data-action="collapse"]').on("click", function(e) {

        e.preventDefault(), $(this).closest(".card").find('[data-action="collapse"] i').toggleClass("ti-minus ti-plus"), $(this).closest(".card").children(".card-body").collapse("toggle")

    }), $('a[data-action="expand"]').on("click", function(e) {

        e.preventDefault(), $(this).closest(".card").find('[data-action="expand"] i').toggleClass("mdi-arrow-expand mdi-arrow-compress"), $(this).closest(".card").toggleClass("card-fullscreen")

    }), $('a[data-action="close"]').on("click", function() {

        $(this).closest(".card").removeClass().slideUp("fast")

    }), $(window).scroll(a), a();

    var i, d = ["skin-default", "skin-green", "skin-red", "skin-blue", "skin-purple", "skin-megna", "skin-default-dark", "skin-green-dark", "skin-red-dark", "skin-blue-dark", "skin-purple-dark", "skin-megna-dark"];



    function l(e) {

        var a, i;

        return $.each(d, function(e) {

            $("body").removeClass(d[e])

        }), $("body").addClass(e), a = "skin", i = e, "undefined" != typeof Storage ? localStorage.setItem(a, i) : window.alert("Please use a modern browser to properly view this template!"), !1

    }(i = function(e) {

        if ("undefined" != typeof Storage) return localStorage.getItem("skin");

        window.alert("Please use a modern browser to properly view this template!")

    }()) && $.inArray(i, d) && l(i), $("[data-skin]").on("click", function(e) {

        $(this).hasClass("knob") || (e.preventDefault(), l($(this).data("skin")))

    }), $("#themecolors").on("click", "a", function() {

        $("#themecolors li a").removeClass("working"), $(this).addClass("working")

    })

});

var G = new jsnx.Graph;

G.addWeightedEdgesFrom([

    [2, 3, 10]

]), G.addStar([3, 4, 5, 6, 24, 47, 39], {

    weight: 5

}), G.addStar([2, 1, 0, -1, 84, 97, 39], {

    weight: 3

}), jsnx.draw(G, {

    element: "#canvas",

    weighted: !0,

    edgeStyle: {

        "stroke-width": 10

    }

}), $(document).ready(function() {

    $("#plus_btn").click(function() {

        $("#region_select").slideDown().addClass("region_select"), $(this).hide()

    })

});



function onlyUnique(value, index, self) { 

    return self.indexOf(value) === index;

}

$(document).ready(function($) {
    // Create the database from csv file
    creat_database();

    $("#plus_btn").click(function () {

      $("#region_select").slideDown().addClass("region_select"), $(this).hide()

    })

    var type = $('.graph-subarea a[data-status="active"]').data('type');



    if (typeof(type) != "undefined") {

        $('#chart_'+type).show();

    }

    // init App Year Range Slider
    $("#app_year_range").ionRangeSlider({
      min: 1980,
      max: 2010,
      from: 1980,
      onChange: function (data) {
        app_year = data.from;
        update_graph();
      },
      onFinish: function (data) {
        app_year = data.from;
        update_graph();
      }
    });

});



$(document).on('click', '.graph-subarea a', function(event) {

    event.preventDefault();

    var $this = $(this);

    // empty fips list
    fips_list = [];

    var current_type = $this.data('type');

  if(current_type == 'state'){

    state_form_init($this);

  } else if(current_type == 'ea') {

    ea_form_init($this);

  } else if(current_type == 'county') {

    county_form_init($this);

  } else if(current_type == 'city') {

    city_form_init($this);

  }

});



var map_ids = [];

var  GEAs = [];

var map_short_ids = [];





function state_form_init($this){

  $(".map_area").hide();

  $("#chart_state").show();

  $('.graph-subarea a').attr('data-status', '');

  $this.attr('data-status', 'active');

}

function ea_form_init($this){

  if(map_short_ids.length){

    $(".map_area, .amcharts-legend-div").hide();

    setCountyEAMap(map_short_ids);

    $("#chart_ea_coantainer, #chart_ea").show();

    $('.graph-subarea a').attr('data-status', '');

    $this.attr('data-status', 'active');

  } else {

    alert("Please Select State.");

  }

}

function county_form_init($this){

  if (map_ids.length){

    $(".map_area").hide();

    $("#curtain").show();

    setCountyMap(map_ids);

    $("#chart_county").show();

    $('.graph-subarea a').attr('data-status', '');

    $this.attr('data-status', 'active');

  } else {

    alert("Please Select State.");

  }

  

}

function city_form_init($this){

  $(".map_area").hide();

  $("#chart_city").show();

  $('.grap-subarea a').attr('data-status', '');

  $this.attr('data-status', 'active');

}





var fips_data_file = "https://dl.dropboxusercontent.com/s/bv2dqe8ttgw9fcb/EA_FIPS.csv"; // "EA_FIPS.csv";



var map;



var countymap;

var ea_colors = [

  "#fa8072"

  ];



AmCharts.ready(function() {



    map = new AmCharts.AmMap();

    map.hideCredits = !0;

    var wordlDataProvider = {

        mapVar: AmCharts.maps.usaLow,

        getAreasFromMap: true,

        areas: [ 

        {

          id: "US-AL",

          value: 4447100,

          color: '#E0E0E0'

        }, {

          id: "US-AK",

          value: 626932,

          color: '#E0E0E0'

        }, {

          id: "US-AZ",

          value: 5130632,

          color: '#E0E0E0'

        }, {

          id: "US-AR",

          value: 2673400,

          color: '#E0E0E0'

        }, {

          id: "US-CA",

          value: 33871648,

          color: '#E0E0E0'

        }, {

          id: "US-CO",

          value: 4301261,

          color: '#E0E0E0'

        }, {

          id: "US-CT",

          value: 3405565,

          color: '#E0E0E0'

        }, {

          id: "US-DE",

          value: 783600,

          color: '#E0E0E0'

        }, {

          id: "US-FL",

          value: 15982378,

          color: '#E0E0E0'

        }, {

          id: "US-GA",

          value: 8186453,

          color: '#E0E0E0'

        }, {

          id: "US-HI",

          value: 1211537,

          color: '#E0E0E0'

        }, {

          id: "US-ID",

          value: 1293953,

          color: '#E0E0E0'

        }, {

          id: "US-IL",

          value: 12419293,

          color: '#E0E0E0'

        }, {

          id: "US-IN",

          value: 6080485,

          color: '#E0E0E0'

        }, {

          id: "US-IA",

          value: 2926324,

          color: '#E0E0E0'

        }, {

          id: "US-KS",

          value: 2688418,

          color: '#E0E0E0'

        }, {

          id: "US-KY",

          value: 4041769,

          color: '#E0E0E0'

        }, {

          id: "US-LA",

          value: 4468976,

          color: '#E0E0E0'

        }, {

          id: "US-ME",

          value: 1274923,

          color: '#E0E0E0'

        }, {

          id: "US-MD",

          value: 5296486,

          color: '#E0E0E0'

        }, {

          id: "US-MA",

          value: 6349097,

          color: '#E0E0E0'

        }, {

          id: "US-MI",

          value: 9938444,

          color: '#E0E0E0'

        }, {

          id: "US-MN",

          value: 4919479,

          color: '#E0E0E0'

        }, {

          id: "US-MS",

          value: 2844658,

          color: '#E0E0E0'

        }, {

          id: "US-MO",

          value: 5595211,

          color: '#E0E0E0'

        }, {

          id: "US-MT",

          value: 902195,

          color: '#E0E0E0'

        }, {

          id: "US-NE",

          value: 1711263,

          color: '#E0E0E0'

        }, {

          id: "US-NV",

          value: 1998257,

          color: '#E0E0E0'

        }, {

          id: "US-NH",

          value: 1235786,

          color: '#E0E0E0'

        }, {

          id: "US-NJ",

          value: 8414350,

          color: '#E0E0E0'

        }, {

          id: "US-NM",

          value: 1819046,

          color: '#E0E0E0'

        }, {

          id: "US-NY",

          value: 18976457,

          color: '#E0E0E0'

        }, {

          id: "US-NC",

          value: 8049313,

          color: '#E0E0E0'

        }, {

          id: "US-ND",

          value: 642200,

          color: '#E0E0E0'

        }, {

          id: "US-OH",

          value: 11353140,

          color: '#E0E0E0'

        }, {

          id: "US-OK",

          value: 3450654,

          color: '#E0E0E0'

        }, {

          id: "US-OR",

          value: 3421399,

          color: '#E0E0E0'

        }, {

          id: "US-PA",

          value: 12281054,

          color: '#E0E0E0'

        }, {

          id: "US-RI",

          value: 1048319,

          color: '#E0E0E0'

        }, {

          id: "US-SC",

          value: 4012012,

          color: '#E0E0E0'

        }, {

          id: "US-SD",

          value: 754844,

          color: '#E0E0E0'

        }, {

          id: "US-TN",

          value: 5689283,

          color: '#E0E0E0'

        }, {

          id: "US-TX",

          value: 20851820,

          color: '#E0E0E0'

        }, {

          id: "US-UT",

          value: 2233169,

          color: '#E0E0E0'

        }, {

          id: "US-VT",

          value: 608827,

          color: '#E0E0E0'

        }, {

          id: "US-VA",

          value: 7078515,

          color: '#E0E0E0'

        }, {

          id: "US-WA",

          value: 5894121,

          color: '#E0E0E0'

        }, {

          id: "US-WV",

          value: 1808344,

          color: '#E0E0E0'

        }, {

          id: "US-WI",

          value: 5363675,

          color: '#E0E0E0'

        }, {

          id: "US-WY",

          value: 493782,

          color: '#E0E0E0'

        } ]

    };



    map.imagesSettings = {

      "labelPosition": "middle",

      "labelFontSize": 8

    },



    map.dataProvider = wordlDataProvider;

    map.areasSettings = {

        /*autoZoom: true,

        color: '#03A9F3',

        selectedColor: "#7B7B97",*/



        color: '#E0E0E0',

        selectedColor: "#DB5918",

        OutlineColor: "#CC0000",

        selectedOutlineColor: "#CC0000",

        alpha: 0.8,

        selectable: true,

        unlistedAreasAlpha: 0.1,

        selectedOutlineThickness: 1,

        OutlineThickness: 1,

    };

    map.zoomControl = {

      zoomControlEnabled: 1,

      zoomOnDoubleClick: 1,

      zoomDuration: 1

    };



    

    

    map.addListener("clickMapObject", function (event) {

      

      map.selectedObject = map.dataProvider;



      // toggle showAsSelected

      event.mapObject.showAsSelected = !event.mapObject.showAsSelected;



      // bring it to an appropriate color

      map.returnInitialColor( event.mapObject );



      // let's build a list of currently selected states

      var states = [];

      

      for ( var i in map.dataProvider.areas ) {

        var area = map.dataProvider.areas[ i ];

        if ( area.showAsSelected ) {

          

          states.push( area.title );

          // setCountyMap(map_ids);

          // setCountyEAMap(map_short_ids);



        }

      }

      var id = event.mapObject.id;

     

      var map_id = id.replace("US-", "");
      var map_id_lower = id.replace("US-", "").toLowerCase();

      var map_type = map_id_lower + 'Counties';



      var index = map_ids.indexOf(id);



      if (index > -1) {

          map_ids.splice(index, 1);

          map_short_ids.splice(index, 1);
          map_id_list.splice(index, 1);



      }else{

            map_ids.push(id);

            map_short_ids.push(map_id);
            map_id_list.push(map_id);

      }

      

      // console.log(map_short_ids);

      document.getElementById('chart_state').setAttribute('data-type', map_type);

      

      // loadCountyMap(map_id, map_type);

      // jQuery('.graph-subarea a[data-type="county"]').click();

      update_graph();

    });



    map.write("chart_state");



});



// function loadCountyMap(mapName, map_type) {

    

//     if (AmCharts.maps[map_type] != undefined) {

//         setCountyMap(mapName);

//         setCountyEAMap(mapName);

//     }

//     else {

//         var url = window.location.href+'/dist/js/us-counties/js/'+map_type+'.js';

//         jQuery.getScript(url, function () {

//             setCountyMap(mapName);

//             setCountyEAMap(mapName);

//         });

//     }

// }





/*function get_csv_data(){

  d3.csv(fips_data_file).get(function(error, rows) { 

      console.log(rows);

  });

}*/

//--> 2018-07-20
var class_based, inventor_based, type_toggle, app_year, friends, map, countymap,
  energy_color = {
    "Wind": "#3C8FBB",
    "Solar": "#FFDB87",
    "Hydro": "#4E6EB1",
    "Nuclear": "#D9444E",
    "Biofuel": "#9DD7A5",
    "Geothermal": "#F77C48"
  },
  ea_colors = [
    "#fa8072"
  ],
  fips_list = [],
  map_id_list = [],
  previous_type = "state";

function createClassDatabase(e) {
  class_based = TAFFY(e), console.log("Succeed to get class Based Data")
}

function createInventorDatabase(e) {
  inventor_based = TAFFY(e), console.log("Succeed to get Inventor Based Data")
}

function createTypeToggleDatabase(e) {
  type_toggle = TAFFY(e), console.log("Succeed to get Type Toggle Data")
}

function creat_database() {
  var loading = $.loading();
  loading.open(30000);
  var a1 = $.ajax({
    method: "get",
    dataType: "json",
    url: "https://dl.dropboxusercontent.com/s/052wqqnok9fcfi1/client-based.json"
  }),
    a2 = $.ajax({
      method: "get",
      dataType: "json",
      url: "https://dl.dropboxusercontent.com/s/09kv3sju3im78jh/inventor-based.json"
    }),
    a3 = $.ajax({
      method: "get",
      dataType: "json",
      url: "https://dl.dropboxusercontent.com/s/nwvcg20huq7v99g/type-toggle.json"
    });

  $.when(a1, a2, a3).done(function (r1, r2, r3) {
    createClassDatabase(r1[0]);
    createInventorDatabase(r2[0]);
    createTypeToggleDatabase(r3[0]);
    loading.close();
  });
}

function get_assignee_type() {
  var assignee_type = [];
  if ($("#ck-type-sm-firm").is(":checked")) {
    assignee_type.push("Small & Medium Firms");
  }
  if ($("#ck-type-vb-firm").is(":checked")) {
    assignee_type.push("Venture Backed Firms");
  }
  if ($("#ck-type-lg-firm").is(":checked")) {
    assignee_type.push("Large Firms");
  }
  if ($("#ck-type-university").is(":checked")) {
    assignee_type.push("Academic");
  }
  if ($("#ck-type-government").is(":checked")) {
    assignee_type.push("Government");
  }
  if ($("#ck-type-lone-inventor").is(":checked")) {
    assignee_type.push("Lone Inventor");
  }
  return assignee_type;
}

function get_energy_type() {
  var energy_type = [];
  if ($("#ck-sector-wind").is(":checked")) {
    energy_type.push("Wind");
  }
  if ($("#ck-sector-solar").is(":checked")) {
    energy_type.push("Solar");
  }
  if ($("#ck-sector-hydro").is(":checked")) {
    energy_type.push("Hydro");
  }
  if ($("#ck-sector-nuclear").is(":checked")) {
    energy_type.push("Nuclear");
  }
  if ($("#ck-sector-biofuel").is(":checked")) {
    energy_type.push("Biofuel");
  }
  if ($("#ck-sector-geothermal").is(":checked")) {
    energy_type.push("Geothermal");
  }
  return energy_type;
}

function get_patent() {
  var patent = [],
    assignee_type = get_assignee_type();

  if (type_toggle && assignee_type.length > 0) {
    conf = {
      "assignee_type": assignee_type,
      "country1": "US"
    };
    // if map id data is exists
    if (map_id_list.length > 0) {
      conf["state1"] = map_id_list;
    }

    type_toggle(conf).each(function (e) {
      patent.push(Number(e.patent));
    })
  }

  return patent;
}
/**
 * 
 * @param {*} energy_type 
 * @param {*} a : data -> choosen by class or inventor
 * @param {*} i : boolean -> is class based?
 * @param {*} g : object -> for drawing graph
 */
function query_by_selector(energy_type, a, i, g) {
  var patent = get_patent(),
    nodes = [],
    edges = [];
  conf = {
    "sector": energy_type,
    "application_year": app_year
  };

  // if map id data is exists
  if (map_short_ids.length > 0) {
    conf["state1"] = map_short_ids;
  }

  // if any patent condition
  if (patent.length > 0) {
    conf["patent"] = patent;
  }

  // if any fips condition
  if (fips_list.length > 0) {
    conf["fips"] = fips_list;
  }

  a(conf).each(function (e) {
    var temp = [];
    if (i) {
      nodes.push(e.alter_class);
      nodes.push(e.focal_class);
      temp.push(i ? e.alter_class : e.alter_inv_Lastname);
      temp.push(i ? e.focal_class : e.focal_inv_Lastname);
    } else {
      nodes.push(e.alter_inv_Lastname);
      nodes.push(e.focal_inv_Lastname);
      temp.push(e.alter_inv_Lastname);
      temp.push(e.focal_inv_Lastname);
    }
    edges.push(temp);
  })

  // remove duplicates from nodes
  var uniqueNodes = [];
  $.each(nodes, function (i, el) {
    if ($.inArray(el, uniqueNodes) === -1) uniqueNodes.push(el);
  });

  g.addNodesFrom(uniqueNodes, {
    color: energy_color[energy_type]
  });
  g.addEdgesFrom(edges);

}

// generate a graph from query data
function generateGraph(G) {
  var e, isClassBased = false;

  if (class_based && inventor_based && type_toggle) {
    if ($("#switch-class-inventor").is(":checked")) {
      e = class_based;
      isClassBased = true;
    } else {
      e = inventor_based;
    }

    if ($("#ck-sector-wind").is(":checked")) {
      query_by_selector("Wind", e, isClassBased, G);
    }
    if ($("#ck-sector-solar").is(":checked")) {
      query_by_selector("Solar", e, isClassBased, G);
    }
    if ($("#ck-sector-hydro").is(":checked")) {
      query_by_selector("Hydro", e, isClassBased, G);
    }
    if ($("#ck-sector-nuclear").is(":checked")) {
      query_by_selector("Nuclear", e, isClassBased, G);
    }
    if ($("#ck-sector-biofuel").is(":checked")) {
      query_by_selector("Biofuel", e, isClassBased, G);
    }
    if ($("#ck-sector-geothermal").is(":checked")) {
      query_by_selector("Geothermal", e, isClassBased, G);
    }
  }
}

function update_graph() {
  var g = new jsnx.Graph;
  generateGraph(g), jsnx.draw(g, {
    element: "#canvas",
    weighted: !0,
    withLabels: !0,
    labelStyle: {
      fill: "Black"
    },
    nodeStyle: {
      fill: function (d) {
        return d.data.color;
      },
      stroke: function (d) {
        return d.data.color;
      }
    },
    edgeStyle: {
      "stroke-width": 10,
      fill: '#d3d3d3'
    }
  })
}
$("#switch-class-inventor").on("switchChange.bootstrapSwitch", function (e, a) {
  update_graph()
}), $("#ck-sector-wind").change(function (e) {
  update_graph()
}), $("#ck-sector-solar").change(function (e) {
  update_graph()
}), $("#ck-sector-hydro").change(function (e) {
  update_graph()
}), $("#ck-sector-nuclear").change(function (e) {
  update_graph()
}), $("#ck-sector-biofuel").change(function (e) {
  update_graph()
}), $("#ck-sector-geothermal").change(function (e) {
  update_graph()
}), $("#ck-type-sm-firm").change(function (e) {
  update_graph()
}), $("#ck-type-vb-firm").change(function (e) {
  update_graph()
}), $("#ck-type-lg-firm").change(function (e) {
  update_graph()
}), $("#ck-type-university").change(function (e) {
  update_graph()
}), $("#ck-type-government").change(function (e) {
  update_graph()
}), $("#ck-type-lone-inventor").change(function (e) {
  update_graph()
});
//<-- 2018-07-20

function setCountyMap(mapName) {



    $('#chart_county').html('<div id="curtain"><span>Counties map is loading...</span></div>');



    d3.csv(fips_data_file).get(function(error, rows) { 

      var county_areas = [];

      var county_images = [];

      var states_area = [];

      var k = 0;

      

      for (var i = 0; i < rows.length; i++) {



        var countyname = rows[i]['countyname'];

        // console.log(countyname);

        var fips = rows[i]['fips'];

        county_n = countyname.split(", ");

        var data_state_name = county_n[county_n.length - 1];

        data_state_name = data_state_name.toLowerCase();

        var ea_code = rows[i]['ea'];



        // if(data_state_name == mapName[i]){

        //   county_areas.push({'id':fips, 'value':county_n[0]});

        //   county_images.push({'labelPosition':'center', 'label':county_n[0]+"asdasd"});

        // }



        k++;

      }

      

      for ( var i in map_ids ) {

        var area_code = map_ids[ i ];

        states_area.push({'id':area_code, 'color':'#000000'});

      }



      var dataProvider = {

          // mapVar: AmCharts.maps[mapName+'Counties'],

          mapVar: AmCharts.maps['usCounties2'],

          getAreasFromMap: true,

          areas: states_area,

          // images: county_images,

      };



      countymap = new AmCharts.AmMap();

      countymap.dataProvider = dataProvider;

      countymap.areasSettings = {

          // color: '#E0E0E0',
          color: "#B3B4B5",

          // selectedColor: "#E0E0E0",

          // OutlineColor: "#800000",

          // selectedOutlineColor: "#CC0000",

          selectedColor: "#03A9F3",

          OutlineColor: "#000033",

          selectedOutlineColor: "#000033",

          // color: '#E0E0E0',

          // selectedColor: "#E0E0E0",

          // OutlineColor: "#FF0000",

          // selectedOutlineColor: "#FF0000",

          alpha: 0.5,

          selectable: true,

          unlistedAreasAlpha: 0.1,

          selectedOutlineThickness: 1,

          OutlineThickness: 1,

          // listeners: [{

          //   "event": "rendered",

          //   "method": function(e) {

          //     var curtain = document.getElementById("curtain");

          //     // curtain.parentElement.removeChild(curtain);

          //     $("#curtain").hide();

          //   }

          // }]

      };



      countymap.listeners = [ {

        event: "clickMapObject",

        method: function( event ) {



          // deselect the area by assigning all of the dataProvider as selected object

          countymap.selectedObject = countymap.dataProvider;



          // toggle showAsSelected

          event.mapObject.showAsSelected = !event.mapObject.showAsSelected;



          // bring it to an appropriate color

          countymap.returnInitialColor( event.mapObject );



          // let's build a list of currently selected states

          var states = [];

          for ( var i in countymap.dataProvider.areas ) {

            var area = countymap.dataProvider.areas[ i ];

            if ( area.showAsSelected ) {

              // console.log(area.title);

              states.push( area.title );

            }

          }

          //--> 2018-07-20
          var id = event.mapObject.id;
          var fips = id.replace("C", "");
          if (event.mapObject.showAsSelected) {
            // selected fips
            fips_list.push(Number(fips));
          } else {
            // deselect fips
            var index = fips_list.indexOf(Number(fips));
            if (index > -1) {
              fips_list.splice(index, 1);
            }
          }
          // update graph
          update_graph();
          //<-- 2018-07-20

        }

    } ];

    countymap.hideCredits = !0;

    

    countymap.zoomControl = {

      zoomControlEnabled: 1,

      zoomOnDoubleClick: 1

    };

   

    countymap.write("chart_county");

    });

}


function setCountyEAMap(mapName) {

  var eas_info_box = [];

  var legend_data = [];

  legend_data.splice(0,legend_data.length);



  $('#chart_ea').html('<div id="curtain"><span>EA map is loading...</span></div>');

  

  d3.csv(fips_data_file).get(function(error, data) { 

    var ea_areas = [];

    var selected_ea_groupIDs= [];

    var rest_ea_areas = [];

    const ea_groups = {};

    const ea_groups_dddd = [];



    var k = 0;

      for (var i = 0; i < data.length; i++) {

        var countyname = data[i]['countyname'];



        var fips = data[i]['fips'];

        var ea_code = data[i]['ea'];

        var ea_name_o = data[i]['eaname'];



        if(fips.length < 5){

          fips = 0 + fips;

        }

        ea_name_o = ea_name_o.split(", ");

        ea_name = ea_name_o[0];

        ea_name = ea_name.toLowerCase().replace(/[^A-Z0-9]/ig, "_");

      

        county_n = countyname.split(", ");

        var data_state_name = county_n[county_n.length - 1];

        data_state_name = data_state_name.toLowerCase();

        



        if ((jQuery.inArray( data_state_name, mapName )) > -1){

          

          ea_areas.push({

            //'value':fips,

            'id': 'C'+fips,

            'groupId':ea_code,

            'color':'#E0E0E0',

            'customData': ea_name_o[0],

            // 'group_title': ea_name_o[0]

          });

          if ((jQuery.inArray( ea_code, selected_ea_groupIDs )) == -1){
              selected_ea_groupIDs.push(ea_code);
          }

          eas_info_box.push(data_state_name);



        }



        // if(data_state_name == mapName){

        //   ea_areas.push({

        //     'value':fips,

        //     'id': 'C'+fips,

        //     'groupId':ea_code,

        //     'color':'#E0E0E0',

        //     'customData': ea_name_o[0],

        //     'group_title': ea_name_o[0]

        //   });

        // }



        k++;





      }

      for (var i = 0; i < data.length; i++) {
        var countyname = data[i]['countyname'];

        var fips = data[i]['fips'];
        var ea_code = data[i]['ea'];
        var ea_name_o = data[i]['eaname'];

        if(fips.length < 5){
           fips = 0 + fips;
        }
        
        ea_name_o = ea_name_o.split(", ");
        ea_name = ea_name_o[0];
        ea_name = ea_name.toLowerCase().replace(/[^A-Z0-9]/ig, "_");
      
        county_n = countyname.split(", ");
        var data_state_name = county_n[county_n.length - 1];
        data_state_name = data_state_name.toLowerCase();

        rest_ea_areas.push({
            'id': 'C'+fips,
            'groupId':ea_code,
            'color': '#D3D4D5',
            'customData': ea_name_o[0]
        });

        // if (((jQuery.inArray( ea_code, selected_ea_groupIDs )) > -1) && !((jQuery.inArray( data_state_name, mapName )) > -1)){
          
          // rest_ea_areas.push({
          //   'id': 'C'+fips,
          //   'groupId':ea_code,
          //   'color':'#E0E0E0',
          //   'customData': ea_name_o[0]
          // });

        // }

        k++;


      }
        console.log(rest_ea_areas);
        console.log('pak');
        console.log(ea_areas);


      var ea_areas_n = d3.nest().key(function(d) { return d.groupId; }).entries(ea_areas);

      for (var i = 0; i < ea_areas_n.length; i++) {

        if(ea_areas_n[i]){

          var color_i = ea_colors[i];

          for (var j = 0; j < ea_areas_n[i].values.length; j++) {

            var l = ea_areas_n[i].values[j];

            ea_groups_dddd.push(l);

          }

        }

      }

       var rest_ea_areas_n = d3.nest().key(function(d) { return d.groupId; }).entries(rest_ea_areas);

      for (var i = 0; i < rest_ea_areas_n.length; i++) {
        if(rest_ea_areas_n[i]){
          var color_i = ea_colors[i];
          
          for (var j = 0; j < rest_ea_areas_n[i].values.length; j++) {
            var l = rest_ea_areas_n[i].values[j];
            
            
            ea_groups_dddd.push(l);
          }
          
        }
        
      }



      var usa_states = AmCharts.maps.usaLow.svg.g.path;

      var lengend_random = "lagend-"+Math.random().toString(36).substring(7);

      

      jQuery("#chart_ea_coantainer .amcharts-legend-div").remove();

      var lagen_div = jQuery("#chart_ea_coantainer").prepend('<div class="ea-states-info" id="'+lengend_random+'"></div>')

      

      jQuery.each(eas_info_box.filter( onlyUnique ),function(index, el) {

        var state_name = "US-"+el.toUpperCase();

        console.log("State :"+state_name);

        for (var i = usa_states.length - 1; i >= 0; i--) {

          if(usa_states[i].id == state_name){

            usa_states[i];

            legend_data.push({"title": usa_states[i].title, "color": "#03A9F3"});

          }

        } 

      });



    for ( var i in map_ids ) {

        var area_code = map_ids[ i ];

        ea_groups_dddd.push({'id':area_code, 'color':'#000000'});

    }



    eamap = new AmCharts.AmMap();



    eamap.legend = {

      width: "100%",

      divId: lengend_random,//"ea-states-info",

      marginRight: 27,

      marginLeft: 27,

      equalWidths: true,

      backgroundAlpha: 0.5,

      backgroundColor: "#FFFFFF",

      borderColor: "#ffffff",

      borderAlpha: 1,

      top: 400,

      left: 45,

      data: legend_data

    };



    eamap.dataProvider = {

        // mapVar: AmCharts.maps[mapName+'Counties'],

        mapVar: AmCharts.maps['usCounties2'],

        getAreasFromMap: true,

        areas: ea_groups_dddd,

    };

   

    eamap.areasSettings = {

        // color: '#E0E0E0',
        color: "#D3D4D5",

        selectedColor: "#03A9F3",

        OutlineColor: "#000033",

        selectedOutlineColor: "#000033",

        alpha: 0.8,

        lineAlpha: 0,

        selectable: true,

        unlistedAreasAlpha: 0.1,

        selectedOutlineThickness: 1,

        OutlineThickness: 2,

        outlineAlpha: 2,

        rollOverColor: "#03A9F3",

        rollOverOutlineColor: "#000033",

        balloonText: "[[customData]]",

        autoDisplay: true,

        unlistedAreasAlpha: 0.1,

    };



    var EA_GR_ID = [];

    eamap.listeners = [ {

        event: "clickMapObject",

        method: function( event ) {



          var groupId = event.mapObject.groupId;

          var objectId = event.mapObject.id;


          // if ( ea_areas.findIndex(x => x.id === objectId) > -1 ) {

            

            var EAs = [];

            if ((jQuery.inArray( groupId, EA_GR_ID )) == -1){
              

              for (var j = 0; j < eamap.dataProvider.areas.length; j++) {

                var ea_group_id = eamap.dataProvider.areas[j].groupId;

                if ( groupId == ea_group_id) {

                  eamap.dataProvider.areas[j].showAsSelected = true;

                  EAs.push(eamap.dataProvider.areas[j]);

                  // CURRENT
                  var fips = eamap.dataProvider.areas[j].id.replace("C", "");
                  fips_list.push(Number(fips));

                }

              }

              EA_GR_ID.push(groupId);

            } else {

              EA_GR_ID.splice( EA_GR_ID.indexOf(groupId) , 1);



              for (var k = 0; k < eamap.dataProvider.areas.length; k++) {

                var ea_group_id_k = eamap.dataProvider.areas[k].groupId;

                if ( groupId == ea_group_id_k ) {

                  eamap.dataProvider.areas[k].showAsSelected = false;

                  // CURRENT
                  var fips = eamap.dataProvider.areas[k].id.replace("C", "");
                  fips_list.splice(fips_list.indexOf(Number(fips)), 1);

                } 

              }

            // }

            eamap.selectedObject = eamap.dataProvider;

            eamap.rollOverMapObject(event.mapObject);

          }
          // update graph
          update_graph();

        }

    }];

    eamap.hideCredits = !0;

    

    eamap.zoomControl = {

      zoomControlEnabled: 1,

      zoomOnDoubleClick: 1,

      zoomDuration: 1

    };

      

    eamap.write("chart_ea");

  });

}